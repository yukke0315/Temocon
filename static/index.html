<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Temocon</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Temocon</h1>
    
    <div class="control-panel">
        <!-- 操作ボタン -->
        <button class="btn" onclick="send('volume_up')">Volume UP</button>
        <button class="btn" onclick="send('volume_down')">Volume Down</button>
        <button class="btn" onclick="send('play_pause')">Play / Pause</button>
        <button class="btn" onclick="send('open_youtube')">Open YouTube</button>
        <button class="btn" onclick="send('open_notepad')">Open Notepad</button>
    </div>

    <div id="trackpad" class="trackpad-area">
        TOUCH PAD
    </div>

    <div id="status" class="status">未接続...</div>

    <script>
        // socket作成
        // IPアドレス・ポートを自動取得
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        const statusDiv = document.getElementById("status");
        // タッチパッドのエリア
        const trackpad = document.getElementById("trackpad");

        // 前回の位置
        let last_x = null;
        let last_y = null;

        // 認証
        let isAuthenticaed = false;

        // 接続時
        ws.onopen = () => {
            const password = prompt("パスワードを入力してください");
            ws.send(JSON.stringify({
                type: "auth",
                password: password
            }));
            statusDiv.innerText = "ONLINE";
            statusDiv.style.color = "#0f0";
        };

        // auth成功時
        ws.onmessage = (event) => {
            if (event.data === "auth_ok") {
                isAuthenticated = true;
                statusDiv.innerText = "AUTH OK";
                statusDiv.style.color = "#0f0";
            } else if (event.data === "auth_ng") {
                alert("パスワードが違います");
            }
        };

        // 切断時
        ws.onclose = () => {
            statusDiv.innerText = "OFFLINE";
            statusDiv.style.color = "#f00";
        };

        // コマンド送信
        function send(command) {
            if (!isAuthenticated) {
                return;
            }
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(command);
            }
        }

        // タッチパッド操作
        // 最初の基準点
        trackpad.addEventListener("touchstart", (e) => {
            // 指は1本だけ
            if (e.touches.length === 1) {
                last_x = e.touches[0].clientX;
                last_y = e.touches[0].clientY;
            }
        }, { passive: false });

        // 指の移動時
        trackpad.addEventListener("touchmove", (e) => {
            e.preventDefault(); // スクロール防止
            // 指は1本だけ
            if (e.touches.length === 1 && ws.readyState === WebSocket.OPEN) {
                const current_x = e.touches[0].clientX;
                const current_y = e.touches[0].clientY;

                // Δ計算
                const dx = current_x - last_x;
                const dy = current_y - last_y;

                // 送信（JSON形式）
                const data = JSON.stringify({ x: dx, y: dy });
                ws.send(data);

                // 更新
                last_x = current_x;
                last_y = current_y;
            }
        }, { passive: false });

        // 指を離したとき
        trackpad.addEventListener("touchend", (e) => {
            // リセット
            last_x = 0;
            last_y = 0;
        }, { passive: false });

        // タッチ
        trackpad.addEventListener("click", (e) => {
            send("left_click");
        });

    </script>
</body>
</html>