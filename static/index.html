<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Temocon</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
    <header class="header">
        <div class="title">Temocon</div>
        <div class="status online" id="status">● Online</div>
    </header>

    <!-- トラックパッド -->
    <main class="trackpad" id="trackpad"></main>

    <!-- 下部操作エリア -->
    <footer class="controls">
        <div class="pointer-controls">
            <button class="btn mode">Drag</button>
            <button class="btn mode active">Scroll</button>
            <button class="btn mode">Right Click</button>
        </div>

        <div class="media-controls">
            <button class="circle" onclick="send('volume_down')">Vol -</button>
            <button class="circle" onclick="send('volume_up')">Vol +</button>
            <button class="circle" onclick="send('play_pause')">Play/Pause</button>   <!-- 絵文字きれいなものに要置き換え -->
            <button class="circle" onclick="send('mute')">Mute</button>
        </div>

        <div class="launcher">
            <button class="app-btn" onclick="send('open_youtube')">YouTube</button>
            <button class="app-btn" onclick="send('open_notepad')">Notepad</button>
            <button class="app-btn" onclick="send('open_terminal')">Terminal</button>
            <button class="app-btn" onclick="send('open_browser')">Browser</button>
            <button class="app-btn empty circle">+</button>
            <button class="app-btn empty circle">+</button>
            <button class="app-btn empty circle">+</button>
            <button class="app-btn empty circle">+</button>
        </div>
    </footer>
    </div>

    <script>
        // socket作成
        // IPアドレス・ポートを自動取得
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        const statusDiv = document.getElementById("status");
        // タッチパッドのエリア
        const trackpad = document.getElementById("trackpad");

        // 前回の位置
        let last_x = null;
        let last_y = null;

        // 認証
        let isAuthenticated = false;
        let sessionToken = null;

        // 接続時
        ws.onopen = () => {
            const password = prompt("Enter password:");
            ws.send(JSON.stringify({
                type: "auth",
                password: password
            }));
            statusDiv.innerText = "ONLINE";
            statusDiv.style.color = "#0f0";
        };

        // auth成功時
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);   // JSONをJSのオブジェクトに変換

            if (msg.type === "auth_ok") {
                isAuthenticated = true;
                sessionToken = msg.session_token;   // セッショントークンを保存

                statusDiv.innerText = "AUTH OK";
                statusDiv.style.color = "#0f0";
            } else if (msg.type === "auth_ng") {
                statusDiv.innerText = "AUTH NG";
                statusDiv.style.color = "#f00";
                alert("Auth failed. Please reload and try again.");
            }
        };

        // 切断時
        ws.onclose = () => {
            statusDiv.innerText = "OFFLINE";
            statusDiv.style.color = "#f00";
        };

        // コマンド送信
        function send(command) {
            if (!isAuthenticated) {
                return;
            }
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "command",
                    command: command,
                    session_token: sessionToken
                }));
            }
        }

        // タッチパッド操作
        // 最初の基準点
        trackpad.addEventListener("touchstart", (e) => {
            // 指は1本だけ
            if (e.touches.length === 1) {
                last_x = e.touches[0].clientX;
                last_y = e.touches[0].clientY;
            }
        }, { passive: false });

        // 指の移動時
        trackpad.addEventListener("touchmove", (e) => {
            e.preventDefault(); // スクロール防止
            // 指は1本だけ
            if (e.touches.length === 1 && ws.readyState === WebSocket.OPEN) {
                const current_x = e.touches[0].clientX;
                const current_y = e.touches[0].clientY;

                // Δ計算
                const dx = current_x - last_x;
                const dy = current_y - last_y;

                // 送信（JSON形式）
                const data = JSON.stringify({
                    type: "move",
                    x: dx, 
                    y: dy,
                    session_token: sessionToken
                });
                ws.send(data);

                // 更新
                last_x = current_x;
                last_y = current_y;
            }
        }, { passive: false });

        // 指を離したとき
        trackpad.addEventListener("touchend", (e) => {
            // リセット
            last_x = 0;
            last_y = 0;
        }, { passive: false });

        // タッチ
        trackpad.addEventListener("click", (e) => {
            send("left_click");
        });

    </script>
</body>
</html>